
# 仕様書：LLMオラクル統合オントロジーアライメント

## 1. 機能要件
- F1: LogMap 自動実行（ベースライン）
- F2: M_ask（不確実マッピング）の抽出
- F3: LLMオラクル診断（6テンプレート × 複数モデル）
- F4: 診断結果の反映（受理/棄却）
- F5: 指標算出（Se/Sp/YI、Precision/Recall/F-score）
- F6: Simulated Oracle 比較（Or_0/10/20/30）
- F7: 可視化（ボックスプロット、レーダー、表形式）

## 2. 非機能要件
- 性能：並列照会で 3 秒未満/問 目標（モデル・テンプレ依存）
- コスト：100–250 tokens/照会、$0.075〜$0.15 / 1M tokens 目安
- 信頼性：出力検証＋リトライ、フォーマット逸脱対策
- 再現性：複数ランの分散が低いこと（YI σ ≈ 0.001–0.005）

## 3. 入出力定義
- 入力：
  - `M_ask.tsv`：`task_id, e1_id, e2_id, label_e1, label_e2, parents_e1[], parents_e2[], syns_e1[], syns_e2[]`
  - `M_RA.tsv`：参照アラインメント（同値ペア）
- 出力：
  - `oracle_results.tsv`：`task_id, e1_id, e2_id, prompt_type, model, verdict(True/False)`
  - `diagnostics.tsv`：`TP, FP, TN, FN, Se, Sp, YI`
  - `final_alignment.tsv`：LLM反映後の M_S
  - `scores.tsv`：Precision, Recall, F-score（前後比較）

## 4. プロンプト仕様（概要）
- **P**：最小（ラベル＋親1）
- **P_EC**：階層2レベル
- **P_NLF**：自然文（親1）
- **P_NLF_EC**：自然文＋階層2レベル
- **P_NLF_S**：自然文＋同義語
- **P_NLF_EC+S**：自然文＋階層2レベル＋同義語
- 期待応答：厳密に `True` / `False`

## 5. 診断アルゴリズム
1. 各 ⟨e1,e2⟩ にテンプレート適用 → LLM呼び出し
2. 応答検証：`lower().strip()` が `true`/`false` 以外は再試行
3. 集計：M_RA と突合し TP/FP/TN/FN 更新
4. 指標計算：式 (1)(2) に従う

## 6. エラー処理
- API失敗：指数バックオフで最大 N 回再試行
- レート超過：キューイング＋スロットリング
- 出力不正：再試行、最悪時は `unknown` として除外

## 7. セキュリティ・法務
- APIキーは環境変数で安全管理
- ベンチマークへの学習漏洩可能性に留意（盲目的評価の推奨）

## 8. 拡張
- Few-shot / RAG の導入
- 複数LLMのアンサンブル
