
# 実装指示書：LLMオラクルによるオントロジーアライメント再現

本指示書は、論文「Large Language Models as Oracles for Ontology Alignment（arXiv:2508.08500v1）」に基づき、**LogMap** に **LLMベースのオラクル** を組み込み、OAEIタスク（Anatomy / Bio-ML / Largebio）で評価を再現するための作業手順を示します。

---
## 0. ゴール
- LogMap の M_ask（不確実マッピング集合）に対して LLM オラクルに True/False 診断を照会
- Prompt テンプレート 6種 × LLMモデル（GPT-4o Mini, Gemini Flash 1.5/2.0/2.0 Lite/2.5）で診断性能（Sensitivity, Specificity, Youden’s Index）を算出
- オラクル導入前後の **Precision, Recall, F-score** を比較
- 追加で **Simulated Oracles（Or_0/10/20/30）** との比較を実施

## 1. 環境準備
- OS: Linux/Windows/Mac いずれも可
- 推奨スペック: 一般的なノートPCで可（API制限がボトルネック）
- ソフトウェア:
  - Java 11+（LogMap 実行用）
  - Python 3.10+
  - パッケージ: `pandas`, `matplotlib`（解析・可視化用）
- 外部API:
  - OpenAI（Chat Completions API; GPT-4o Mini）
  - Google Gemini API（Flash 1.5 / 2.0 / 2.0 Lite / 2.5）
- 認証情報（環境変数で設定）:
  - `OPENAI_API_KEY`
  - `GEMINI_API_KEY`（OpenAI互換エンドポイント経由のSDKを想定）

## 2. データ入手（OAEI）
- 対象トラックとタスク:
  - Anatomy: Mouse–Human
  - Bio-ML: NCIT–DOID, OMIM–ORDO, SNOMED–FMA.body, SNOMED–NCIT.neoplas, SNOMED–NCIT.pharm
  - Largebio: FMA–NCI, FMA–SNOMED, SNOMED–NCI
- 各タスクの **O1/O2**（ソース/ターゲット）と **M_RA**（参照アラインメント）を取得
- データ配置例:
  - `data/<track>/<task>/source.owl`
  - `data/<track>/<task>/target.owl`
  - `data/<track>/<task>/reference.rdf` （または `.tsv`）

## 3. LogMap の準備
- 公式配布の LogMap を取得し、**インタラクティブモード**（オラクル連携）を有効化
- 出力:
  - 自動モードでのアラインメント **M_S**
  - 不確実集合 **M_ask**（LogMap が質問したいマッピングの集合）

## 4. LLMオラクル統合（オンデマンド診断）
- M_ask の各マッピング ⟨e1, e2⟩ に対して以下情報を抽出:
  - `label(e)`（ラベル）
  - `synonyms(e)`（同義語; 可能なら）
  - `parent(e)` / `parents(e)`（親クラス階層; 最大2レベル）
- 6種類の **プロンプトテンプレート** を動的生成：
  1. **P**（構造化／最小情報）
  2. **P_EC**（構造化／拡張コンテキスト）
  3. **P_NLF**（自然文）
  4. **P_NLF_EC**（自然文＋拡張コンテキスト）
  5. **P_NLF_S**（自然文＋同義語）
  6. **P_NLF_EC+S**（自然文＋拡張コンテキスト＋同義語）
- セッション用 **System Prompt**（任意）：
  - 例）「あなたはオントロジー整合の専門家です。ラベル、同義語、親階層を重視して判断し、True/False を厳格に返す」
- API呼び出し仕様：
  - 出力形式は **厳密な真偽値**（`True`/`False`）を強制
  - **バリデーション＆リトライ**（出力が逸脱した場合は再試行）
  - 呼び出しは **M_ask のみ**（コスト節約）

## 5. 診断結果の集約
- 各 ⟨e1,e2⟩ について LLMの回答を **TP/FP/TN/FN** に分類（M_RA 基準）
- 指標計算：
  - Sensitivity（Se）= TP / (TP + FN)
  - Specificity（Sp）= TN / (FP + TN)
  - Youden’s Index（YI）= Se + Sp − 1

## 6. 全体性能への反映
- LLM診断を LogMap に反映（受理/棄却）し、最終アラインメントを再計算
- **Precision, Recall, F-score** を算出し、自動モードと比較

## 7. シミュレート・オラクル比較
- Or_0 / Or_10 / Or_20 / Or_30 を実装（M_RA に基づく擬似誤答率を付与）
- LogMap+各Or と LogMap+LLM を比較

## 8. 再現のための運用ヒント
- レート制限：Gemini ≈ 2,000 RPM、OpenAI 初期 500 RPM/日 10,000 リクエスト（モデルにより変動）
- コスト目安：入力 100–250 tokens/req、$0.075〜$0.15 / 1M tokens（モデル・版に依存）
- 解析は **複数回走査**でも偏差は小（YIの標準偏差 ≈ 0.001–0.005）

## 9. 成果物
- スクリプト群（データ抽出／プロンプト生成／API呼び出し／集計）
- レポート（タスク別ボックスプロット、表形式比較）

## 10. 検証チェックリスト
- [ ] M_ask が抽出されている
- [ ] Prompt 6種が正しく生成される
- [ ] 出力が厳密な True/False である
- [ ] Se/Sp/YI が妥当（範囲内）
- [ ] F-score 改善が確認できる
- [ ] Or_20 と同等水準の傾向確認
